# Adapted from:
# http://homepage.mac.com/shawnce/misc/java_functions_bashrc.txt
# Written by Shawn Erickson - shawn at freetimesw.com

export CURRENT_MODE_STRING="";

function defaultPrompt()
{
    _defaultPrompt()
    {
        CURRENT_MODE=$(echo $CURRENT_MODE_STRING)
    }

    PROMPT_COMMAND=_defaultPrompt
#   PS1="\h:\w\n\${CURRENT_MODE:+[\$CURRENT_MODE] }\u@\t\$ "

}

defaultPrompt

### Java Environment Functions ###

J_VERSIONS_DIRECTORY="/System/Library/Frameworks/JavaVM.framework/Versions"
J_COMMANDS_SUBPATH="Commands"
J_HOME_SUBPATH="Home"

function availableJVMs()
{
    ls -1 $J_VERSIONS_DIRECTORY | grep ^[0-9].[0-9]
}

function listJava()
{
    local jvms=$(availableJVMs)
    echo "Available JVMs: "$jvms

    echo "Current Java:"
    java -version
}

function setJava()
{
    local target_jvm=""
    local jvms=$(availableJVMs)

    # Validate that the user requested an available JVM present on the system

    for jvm in $jvms ; do
        if [ "$jvm" == "$@" ]; then
            target_jvm=$@
        fi
    done

    if [ "$target_jvm" == "" ]; then
        echo "Unsupported Java version requested"
        return;
    fi

    # If we get here the user asked for a valid JVM, so configure it

    echo "Configuring Shell Environment for Java "$@

    # First unset any current set java, back to default before doing configuration
    _unsetJava

    # Generate the paths needed for the JVM requested
    local jcmd="${J_VERSIONS_DIRECTORY}/$@/${J_COMMANDS_SUBPATH}"
    local jhome="${J_VERSIONS_DIRECTORY}/$@/${J_HOME_SUBPATH}"

    # We save the original path so we can toggle back if unset
    ORIGINAL_PATH="$PATH"
    PATH="$jcmd:${PATH}"

    # We save the original JAVA_HOME so we can toggle back if unset
    ORIGINAL_JAVA_HOME="$JAVA_HOME"
    export JAVA_HOME="$jhome"

    # Update command prompt mode tag to note JVM setting
    CURRENT_MODE_STRING="J$@"

    echo "Current Java:"
    java -version
}

function _unsetJava()
{
    if [ "$CURRENT_MODE_STRING" != "" ]; then
            PATH="$ORIGINAL_PATH"
        JAVA_HOME="$ORIGINAL_JAVA_HOME"
        CURRENT_MODE_STRING=""
    fi
}

function unsetJava()
{
    echo "Configuring Shell Environment for default Java"
    _unsetJava

    echo "Current Java:"
        java -version
}

function send_key()
{
    cat ~/.ssh/id_dsa.pub | \
        ssh $1 "mkdir ~/.ssh;
            touch ~/.ssh/authorized_keys;
            cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys && chmod 700 ~/.ssh";
}

alias j4='setJava 1.4.2'
alias j5='setJava 1.5.0'

# My own aliases -- TMM

alias fail='find . -name \*.txt |xargs grep -l '\''FAILURE'\'' |xargs mate'

function idea() {
    IDEA=`ls -1d /Applications/IntelliJ\ * | tail -n1`

    if [ -f "$1" ]; then      # first, try any filename provided
        open -a "$IDEA" "$1"
    elif [ -f pom.xml ]; then # second, try pom.xml
        open -a "$IDEA" pom.xml
    elif [ -f *.ipr ]; then   # third, try any IDEA project files
        open -a "$IDEA" `ls -1d *.ipr | head -n1`
    else                      # finally, just open IDEA
        open "$IDEA"
    fi
}

